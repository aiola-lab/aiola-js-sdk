<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aiola STT Demo</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      #transcript {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        min-height: 100px;
      }
      .controls {
        margin: 20px 0;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        margin-right: 10px;
      }
      .toggle-container {
        display: flex;
        gap: 20px;
        margin: 20px 0;
        align-items: flex-end;
      }
      .toggle-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 60px;
      }
      .separator {
        color: #ccc;
        font-size: 20px;
        line-height: 1;
        padding: 0 10px;
      }
      .toggle-label {
        color: #666;
        font-size: 14px;
        user-select: none;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        width: 100%;
      }
      .toggle-label i {
        font-size: 20px;
        display: inline-block;
      }
      .toggle-button {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
        border-radius: 15px;
        background-color: #bfbfbf;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .toggle-button.active {
        background-color: #4caf50;
      }
      .toggle-button::before {
        content: "";
        position: absolute;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background-color: white;
        top: 2px;
        left: 2px;
        transition: all 0.3s ease;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .toggle-button.active::before {
        left: 32px;
      }
      .toggle-button i {
        position: absolute;
        font-size: 14px;
        color: #666;
        z-index: 2;
        top: 50%;
        transform: translateY(-50%);
        left: 10px;
        transition: all 0.3s ease;
      }
      .toggle-button.active i {
        left: 40px;
        color: #4caf50;
      }
      .message-container {
        margin: 0;
        padding: 0;
        min-height: 24px;
        font-size: 14px;
        color: #666;
        flex: 1;
        display: flex;
        align-items: flex-end;
        line-height: 20px;
      }
      .message-container span {
        color: #2e7d32;
      }
      .message-container span.error {
        color: #d32f2f;
      }
    </style>
  </head>
  <body>
    <h1>Aiola Speech-to-Text Demo</h1>

    <div class="toggle-container">
      <div class="toggle-group">
        <div id="socketToggle" class="toggle-button">
          <i class="ti ti-plug-connected-x"></i>
        </div>
      </div>
      <div class="toggle-group">
        <div id="recordingToggle" class="toggle-button">
          <i class="ti ti-microphone-off"></i>
        </div>
      </div>
      <span class="separator">|</span>
      <div class="message-container" id="messageContainer">
        Ready to connect
      </div>
    </div>

    <div id="transcript"></div>

    <script type="module">
      import { AiolaStreamingClient } from "/libs/stt/dist/esm/index.js";

      const messageContainer = document.getElementById("messageContainer");
      const socketToggle = document.getElementById("socketToggle");
      const recordingToggle = document.getElementById("recordingToggle");

      function showMessage(message, isError = false) {
        messageContainer.innerHTML = `<span class="${
          isError ? "error" : ""
        }">${message}</span>`;
      }

      function updateSocketStatus(connected) {
        socketToggle.classList.toggle("active", connected);
        recordingToggle.classList.toggle("active", false);
        const socketIcon = socketToggle.querySelector("i");
        if (socketIcon) {
          socketIcon.className = connected
            ? "ti ti-plug-connected"
            : "ti ti-plug-connected-x";
        }
        const micIcon = recordingToggle.querySelector("i");
        if (micIcon) {
          micIcon.className = "ti ti-microphone-off";
        }
        showMessage(
          connected ? "Socket connected successfully" : "Socket disconnected"
        );
      }

      const client = new AiolaStreamingClient({
        baseUrl: "https://api-testing.internal.aiola.ai",
        bearer: "fa6a7a103c2b008301088471e7aab343",
        transports: "polling",
        queryParams: {
          flow_id: "848f4a40-5c3d-481b-a2c6-da0b3d99e7e0",
          execution_id: "3333",
          lang_code: "en_US",
          time_zone: "UTC",
        },
        micConfig: {
          sampleRate: 16000,
          chunkSize: 4096,
          channels: 1,
        },
        events: {
          onTranscript: (data) => {
            console.log("Transcript:", data.transcript);
            const transcriptDiv = document.getElementById("transcript");
            const newTranscript = document.createElement("div");
            newTranscript.textContent = data.transcript;
            transcriptDiv.appendChild(newTranscript);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
          },
          onEvents: (data) => {
            console.log("Event:", data);
          },
          onConnect: () => {
            updateSocketStatus(true);
          },
          onError: (error) => {
            console.error("Connection error:", error);
            updateSocketStatus(false);
            showMessage("Connection error: " + error, true);
          },
          onStartRecord: () => {
            showMessage("Recording started");
            recordingToggle.classList.add("active");
            const micIcon = recordingToggle.querySelector("i");
            if (micIcon) {
              micIcon.className = "ti ti-microphone";
            }
          },
          onStopRecord: () => {
            showMessage("Recording stopped");
            recordingToggle.classList.remove("active");
            const micIcon = recordingToggle.querySelector("i");
            if (micIcon) {
              micIcon.className = "ti ti-microphone-off";
            }
          },
        },
      });

      socketToggle.addEventListener("click", async () => {
        const isConnected = socketToggle.classList.contains("active");
        try {
          if (isConnected) {
            client.closeSocket();
            const isRecording = recordingToggle.classList.contains("active");
            if (isRecording) {
              client.stopRecording();
            }
            updateSocketStatus(false);
          } else {
            showMessage("Connecting...");
            await client.openSocket();
          }
        } catch (error) {
          showMessage("Connection error: " + error, true);
        }
      });

      recordingToggle.addEventListener("click", async () => {
        const isRecording = recordingToggle.classList.contains("active");
        try {
          if (isRecording) {
            client.stopRecording();
            recordingToggle.classList.remove("active");
            const micIcon = recordingToggle.querySelector("i");
            if (micIcon) {
              micIcon.className = "ti ti-microphone-off";
            }
          } else {
            showMessage("Starting recording...");
            await client.startRecording();
            const micIcon = recordingToggle.querySelector("i");
            if (micIcon) {
              micIcon.className = "ti ti-microphone";
            }
          }
        } catch (error) {
          showMessage("Recording error: " + error, true);
        }
      });
    </script>
  </body>
</html>
